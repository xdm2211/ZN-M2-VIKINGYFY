# 云编译公用核心 - 极致 100% 完美版
name: WRT-CORE

on:
  workflow_call:
    inputs:
      WRT_CONFIG: { required: true, type: string }
      WRT_THEME: { required: true, type: string }
      WRT_NAME: { required: true, type: string }
      WRT_IP: { required: true, type: string }
      WRT_REPO: { required: true, type: string }
      WRT_BRANCH: { required: true, type: string }
      WRT_SOURCE: { required: true, type: string }
      WRT_PACKAGE: { required: false, type: string }
      WRT_TEST: { required: false, type: string }

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  WRT_CONFIG: ${{ inputs.WRT_CONFIG }}
  WRT_THEME: ${{ inputs.WRT_THEME }}
  WRT_NAME: ${{ inputs.WRT_NAME }}
  WRT_IP: ${{ inputs.WRT_IP }}
  WRT_REPO: ${{ inputs.WRT_REPO }}
  WRT_BRANCH: ${{ inputs.WRT_BRANCH }}
  WRT_SOURCE: ${{ inputs.WRT_SOURCE }}
  WRT_PACKAGE: ${{ inputs.WRT_PACKAGE }}
  WRT_TEST: ${{ inputs.WRT_TEST }}

jobs:
  core:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout Projects
        uses: actions/checkout@main

      - name: Initialization Environment
        run: |
          # 1. 极致深度清理磁盘空间
          sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/boost /usr/share/swift /var/lib/mongodb /usr/local/share/powershell
          sudo docker image prune -a -f
          sudo apt-get remove -y 'php.*' 'mysql.*' 'azure.*' 'google.*' firefox google-chrome-stable powershell
          sudo apt-get autoremove -y
          sudo apt-get clean
          # 2. 注入编译环境依赖
          sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
          sudo timedatectl set-timezone "Asia/Shanghai"

      - name: Clone Source Code
        run: |
          git clone --depth=1 --single-branch --branch $WRT_BRANCH $WRT_REPO wrt
          cd wrt/ && echo "WRT_DATE=$(date +%Y.%m.%d)" >> $GITHUB_ENV

      - name: Update & Install Feeds
        run: |
          cd ./wrt/
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Custom Packages
        run: |
          cd ./wrt/package/
          # 调用外部脚本更新插件
          bash $GITHUB_WORKSPACE/Scripts/Packages.sh

      - name: Custom Handles
        run: |
          cd ./wrt/
          # 执行 NSS 优化、去无线补丁、Rust 修复
          bash $GITHUB_WORKSPACE/Scripts/Handles.sh

      - name: Custom Settings
        run: |
          cd ./wrt/
          # 组合配置文件：设备配置 + 通用配置
          cat $GITHUB_WORKSPACE/Config/$WRT_CONFIG.txt $GITHUB_WORKSPACE/Config/GENERAL.txt > .config
          
          # 显式导出变量供 Settings.sh 使用
          export WRT_IP=${{ inputs.WRT_IP }}
          export WRT_NAME=${{ inputs.WRT_NAME }}
          export WRT_PACKAGE=${{ inputs.WRT_PACKAGE }}
          bash $GITHUB_WORKSPACE/Scripts/Settings.sh
          
          # 修正依赖关系并静默处理
          make defconfig

      - name: Download Packages
        if: env.WRT_TEST != 'true'
        run: |
          cd ./wrt/
          make download -j$(nproc)
          find dl -size -1024c -exec rm -f {} \;

      - name: Compile Firmware
        if: env.WRT_TEST != 'true'
        run: |
          cd ./wrt/
          # 首次尝试多线程，失败则单线程输出详细日志
          make -j$(nproc) || make -j1 V=s

      - name: Package Firmware
        run: |
          cd ./wrt/ && mkdir ./upload/
          cp -f ./.config ./upload/Config-"$WRT_CONFIG"-"$WRT_DATE".txt
          if [[ $WRT_TEST != 'true' ]]; then
            # 清理无用后缀文件
            find ./bin/targets/ -iregex ".*\(buildinfo\|json\|sha256sums\|packages\)$" -exec rm -rf {} +
            cp -rf $(find ./bin/targets/ -type f -name "*$WRT_TARGET*") ./upload/
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@main
        with:
          name: ${{ env.WRT_CONFIG }}-${{ env.WRT_DATE }}
          path: ./wrt/upload/